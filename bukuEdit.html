<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="Img/libralyra.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hedvig+Letters+Serif:opsz@12..24&family=Poppins&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hedvig+Letters+Serif:opsz@12..24&family=Poppins&family=Varela&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="asset/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="asset/plugins/fontawesome-free/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script defer src="init.js"></script>
    <title>LibraLyra</title>
</head>
<style>
    body, html, :root {
        margin: 0;
        padding: 0;
        border: 0;
        font-size: 100%;
        font: inherit;
        vertical-align: baseline;
        background-position: center;
    }
    main{
        font-family: "poppins";
        width: 100%;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background-image: url("Img/bg2.jpg");
        background-position: center;
        background-size: cover;}

button {
    padding: 0;
    margin: 0;
    font-size: inherit;
    font-family: inherit;
    color: inherit;
    background-color: transparent;
    border: none;
    cursor: pointer;
}
#submit{
    background-color: #76a7d3;
}
#submit:hover{
    background-color: #5c78b4;
}
#kembali{
    border: #eb8441 1px solid;
    color: #eb8441;
}
#kembali:hover{
    background-color: #eb8441;
    color: white;
}
</style>

<body>
    
    <main>
        <div class="container">
            <div class="row justify-content-center" >
                <div class="col-md-5">
                    <form id="bookForm" >
                        <div class="card shadow" >
                            <div class="card-header text-white" style="background-color: #ed8340; padding: 20px;">
                                <h5 class="mb-0" style="text-align: center; font-weight: bold;">Edit Buku</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <input type="hidden" name="id" id="id" value="">
                                    <label for="isbn">Isbn</label>
                                    <input type="text" class="form-control" id="isbn" name="isbn" placeholder="Masukkan Isbn buku" required>
                                </div>
                                <div class="form-group">
                                    <label for="judul">Judul Buku</label>
                                    <input type="text" class="form-control" id="judul" name="judul" placeholder="Masukkan Judul buku" required>
                                </div>
                                <div class="form-group">
                                    <label for="pengarang">Pengarang</label> 
                                    <input type="text" class="form-control" id="pengarang" name="pengarang" placeholder="Masukkan Nama Pengarang" required>
                                </div>
                                <div class="form-group">
                                    <label for="penerbit">Penerbit</label>  
                                    <input type="text" class="form-control" id="penerbit" name="penerbit" placeholder="Masukkan Nama Penerbit" required>
                                </div>
                                <div class="form-group">
                                    <label for="tahun_terbit">Tahun Terbit</label>
                                    <input type="number" class="form-control" id="tahun_terbit" name="tahun_terbit" placeholder="Masukkan Tahun Penerbitan" required>
                                </div>
                                <div class="form-group">
                                    <label for="jenis">Jenis Buku</label>
                                    <input type="text" class="form-control" id="jenis" name="jenis" placeholder="Masukkan Jenis Buku" required>
                                </div>
                                <div class="form-group">
                                    <label for="deskripsi">Deskripsi Buku</label>  
                                    <textarea class="form-control" id="deskripsi" name="deskripsi" placeholder="Masukkan Deskripsi buku" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="stock">Stock Buku</label>
                                    <input type="number" class="form-control" id="stock" name="stock" min="0"  placeholder="Masukkan Stock buku" required>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button id="kembali" type="button" style="font-weight: 4X00;" class="btn" onclick="return window.location.href = 'buku.html';">Kembali</button>
                                <button id="submit" type="button" style="color: white; font-weight: 4X00;" class="btn float-right">Simpan</button>
                            </div>
                        </div>
                    </form>
                    <div class="form-group">
                        <label for="file">Gambar Buku</label>
                        <input style="padding-bottom: 35px; padding-left: 6px;" type="file" class="form-control" id="file" name="file" min="0"  placeholder="Masukkan Stock buku" required>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        // read data ygy
        $(document).ready(function () {
            let token = localStorage.getItem('token');
            var bookId = new URLSearchParams(window.location.search).get('id');
            document.getElementById('id').value = bookId;
            if (!bookId) {
                alert("Book ID not found");
                return window.location.href = 'buku.html';
            }
            $.ajax({
                url: `http://localhost/${parentPath}/Backend/index.php/api/admin/buku?id=` + bookId,
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                method: "GET",
                dataType: "json",
                success: function (data) {
                    $('#isbn').val(data.isbn);
                    $('#judul').val(data.judul);
                    $('#pengarang').val(data.pengarang);
                    $('#penerbit').val(data.penerbit);
                    $('#tahun_terbit').val(data.tahun_terbit);
                    $('#jenis').val(data.jenis);
                    $('#deskripsi').val(data.deskripsi);
                    $('#stock').val(data.stock);
                },
                error: function (xhr, status, error) {
                    if (xhr.status === 401) {
                            alert("Anda belum login");
                            window.location.href = "login.html";
                    }
                }
            });
        });
        // update data :v
        $(document).ready(function() {
            $(document).on('click', '#submit', function() {
                let token = localStorage.getItem('token');
                const formData = new FormData(document.getElementById('bookForm'));
                const fileInput = document.getElementById('file');
                const file = fileInput.files[0];
                if(file!=undefined){
                    const fileName = file.name;
                    const reader = new FileReader();
                    reader.onload = function(){
                    formData.append('file', reader.result);
                    formData.append('file_name', fileName); 
                    send(formData, token);
                    }
                    reader.readAsDataURL(file); //read sekalian jadikan bs64
                }
                else{
                    send(formData, token);
                }
            });
        });
        // send ajax soalnya klo digabung kena efek lazy
        function send(formData, token) {
            const serializedString = new URLSearchParams(formData).toString();
            $.ajax({
                type: "PUT",
                url: `http://localhost/${parentPath}/Backend/index.php/api/admin/buku`,
                contentType: "application/x-www-form-urlencoded",
                processData: false,
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                data: serializedString,
                success: function(response) {
                    alert("Book created successfully");
                    window.location.href = 'buku.html';
                },
                error: function(xhr, status, error) {
                    alert(`Error edit buku:${(JSON.parse(xhr.responseText).message.id) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.id):""}${(JSON.parse(xhr.responseText).message.isbn) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.isbn):""}${(JSON.parse(xhr.responseText).message.judul) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.judul):""}${(JSON.parse(xhr.responseText).message.pengarang) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.pengarang):""}${(JSON.parse(xhr.responseText).message.penerbit) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.penerbit):""}${(JSON.parse(xhr.responseText).message.tahun_terbit) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.tahun_terbit):""}${(JSON.parse(xhr.responseText).message.jenis) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.jenis):""}${(JSON.parse(xhr.responseText).message.deskripsi) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.deskripsi):""}${(JSON.parse(xhr.responseText).message.stock) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.stock):""}${(JSON.parse(xhr.responseText).message.file) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.file):""}${(JSON.parse(xhr.responseText).message.file_extension) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.file_extension):""}${(JSON.parse(xhr.responseText).message.file_size) ? ("\nðŸ“Œ"+JSON.parse(xhr.responseText).message.file_size):""}\nPlease try again!`);
                }
        });
    }
    </script>
</body>
</html>